@echo off
rem
rem basic contants for this build setup
rem
set CONFIGCD=%cd%
if "%1%" == "" goto getbuildno
set _buildno=%1
goto havebuildno

:getbuildno

@echo off
echo.
echo.
set /p _buildno=Enter Build # for Transport:
echo.
echo.
:havebuildno
echo.
echo.
echo Build number will be %_buildno%!.
echo.
echo.


set HEADERFILE=buildenv.h
set MKFILE=buildenv.mk
set CONFIG_VERSION_MAJOR=1
set CONFIG_VERSION_MINOR=1
set INAS_MAJOR=1
set INAS_MINOR=1
Set STAMPINF_VERSION=1.1.%_buildno%.0

set CONFIG_COPYRIGHT=(C) SaaSaMe Ltd. All Rights Reserved.
set PRODUCT_VENDOR_STR=SaaSaMe
set PRODUCT_NAME_STR=SaaSaMe Transport
set PRODUCT_NAME_STR_AUTO=SaaSaMe Transport
set PRODUCT_NAME_STR_CLI=SaaSaMe Transport command
set PRODUCT_SHORTNAME_STR=SaaSaMe Transport
set PRODUCT_FULLNAME_STR=SaaSaMe Transport

echo Build number will be %_buildno%!.


:check

rem
rem We will not write over any existing configuration files
rem that may be here. Just warn the user to clean them up
rem

if exist %MKFILE% goto exists
if exist %HEADERFILE% goto exists
goto allok

:exists
rem
rem The buildenv.mk and buildenv.h files generated by the Linux Configure
rem script work fine with the Win32 build. 
rem If we're building soley on a Win32 platform and do not have access
rem to the Linux script then the files this utility creates are fine
rem
echo WARNING: A buildenv.h or buildenv.mk already exists
echo If these have been generated by the Linux Configure script, do not continue
echo A backup copy of the files will be made if you choose to continue
pause
if exist %MKFILE% copy %MKFILE% %MKFILE%.bak
if exist %HEADERFILE% copy %HEADERFILE% %HEADERFILE%.bak

:allok
set CONFIG_DEBUG=n

echo Creating the %HEADERFILE%...
echo /*> %HEADERFILE%
echo * Generated by 'Config.cmd' on %DATE% %TIME%-- don't edit!>> %HEADERFILE%
echo */>> %HEADERFILE%

echo #ifndef _%PRODUCT_VENDOR_STR%_CONFIG_H>> %HEADERFILE%
echo #define _%PRODUCT_VENDOR_STR%_CONFIG_H>> %HEADERFILE%
echo #define CONFIG_DEBUG "%CONFIG_DEBUG%">> %HEADERFILE%

if %_buildno% GTR 700 goto skip

REM echo #define CONFIG_BUILD_DATE_TIME "%DATE% %TIME%">> %HEADERFILE%
for /f "delims=" %%i in ('vDate.cmd') do set output=%%i
echo #define CONFIG_BUILD_DATE_TIME "%output%">> %HEADERFILE%

:skip

echo #define CONFIG_HOME "%CD%">> %HEADERFILE%
echo #define CONFIG_COPYRIGHT "%CONFIG_COPYRIGHT%">> %HEADERFILE%
echo #define CONFIG_COPYRIGHT_WSTR L"%CONFIG_COPYRIGHT%">> %HEADERFILE%
echo #define CONFIG_VERSION_MAJOR "%CONFIG_VERSION_MAJOR%">> %HEADERFILE%
echo #define CONFIG_VERSION_MAJOR_WSTR L"%CONFIG_VERSION_MAJOR%">> %HEADERFILE%
echo #define CONFIG_VERSION_MINOR "%CONFIG_VERSION_MINOR%">> %HEADERFILE%
echo #define CONFIG_VERSION_MINOR_WSTR L"%CONFIG_VERSION_MINOR%">> %HEADERFILE%
echo #define CONFIG_BUILD_ID "%_buildno%">> %HEADERFILE%
echo #define CONFIG_BUILD_ID_WSTR L"%_buildno%">> %HEADERFILE%

echo #define PRODUCT_MAJOR %INAS_MAJOR% >> %HEADERFILE%
echo #define PRODUCT_MINOR %INAS_MINOR% >> %HEADERFILE%
echo #define PRODUCT_BUILD %_buildno% >> %HEADERFILE%
echo #define PRODUCT_NAME_STR "%PRODUCT_NAME_STR%">> %HEADERFILE%
echo #define PRODUCT_NAME_WSTR L"%PRODUCT_NAME_STR%">> %HEADERFILE%
echo #define PRODUCT_FULLNAME_STR "%PRODUCT_FULLNAME_STR%">> %HEADERFILE%
echo #define PRODUCT_FULLNAME_WSTR L"%PRODUCT_FULLNAME_STR%">> %HEADERFILE%
echo #define PRODUCT_SHORTNAME_STR "%PRODUCT_SHORTNAME_STR%">> %HEADERFILE%
echo #define PRODUCT_SHORTNAME_WSTR L"%PRODUCT_SHORTNAME_STR%">> %HEADERFILE%
echo #define PRODUCT_MS_VERSION_STR   "%INAS_MAJOR%.%INAS_MINOR%.%_buildno%.0"  >> %HEADERFILE%
echo #define PRODUCT_MS_VERSION_WSTR  L"%INAS_MAJOR%.%INAS_MINOR%.%_buildno%.0" >> %HEADERFILE%

echo #define PRODUCT_VENDOR_STR "%PRODUCT_VENDOR_STR%">> %HEADERFILE%
echo #define PRODUCT_VENDOR_WSTR L"%PRODUCT_VENDOR_STR%">> %HEADERFILE%
echo #define STAMPINF_VERSION_STR "%STAMPINF_VERSION%">> %HEADERFILE%
echo #define STAMPINF_VERSION_WSTR L"%STAMPINF_VERSION%">> %HEADERFILE%

echo #endif /* ifndef _%PRODUCT_VENDOR_STR%_CONFIG_H */>> %HEADERFILE%


echo Creating the %MKFILE%...
echo CONFIG_DEBUG=%CONFIG_DEBUG%> %MKFILE%
echo CONFIG_BUILD_DATE=%DATE% %TIME%>> %MKFILE%
echo CONFIG_HOME=%CD%>> %MKFILE%
echo CONFIG_COPYRIGHT=%CONFIG_COPYRIGHT%>> %MKFILE%
echo CONFIG_VERSION_MAJOR=%CONFIG_VERSION_MAJOR% >> %MKFILE%
echo CONFIG_VERSION_MINOR=%CONFIG_VERSION_MINOR% >> %MKFILE%
echo CONFIG_BUILD_ID=%_buildno%>> %MKFILE%


echo Creating the AssemblyInfo.cs ...
echo /*> AssemblyInfo.cs
echo * Generated by 'Config.cmd' on %DATE% %TIME%-- don't edit!>> AssemblyInfo.cs
echo */>> AssemblyInfo.cs
echo using System.Reflection;>> AssemblyInfo.cs
echo using System.Runtime.CompilerServices;>> AssemblyInfo.cs
echo.>> AssemblyInfo.cs
echo [assembly: AssemblyTitle("%PRODUCT_NAME_STR%")] >> AssemblyInfo.cs
echo [assembly: AssemblyDescription("%PRODUCT_NAME_STR%")] >> AssemblyInfo.cs
echo [assembly: AssemblyConfiguration("")] >> AssemblyInfo.cs
echo [assembly: AssemblyCompany("%PRODUCT_VENDOR%")] >> AssemblyInfo.cs
echo [assembly: AssemblyProduct("%PRODUCT_SHORTNAME_STR%")] >> AssemblyInfo.cs
echo [assembly: AssemblyCopyright("%CONFIG_COPYRIGHT%")] >> AssemblyInfo.cs
echo [assembly: AssemblyTrademark("")] >> AssemblyInfo.cs
echo [assembly: AssemblyCulture("")] >> AssemblyInfo.cs		
echo [assembly: AssemblyVersion("%CONFIG_VERSION_MAJOR%.%CONFIG_VERSION_MINOR%.%_buildno%.0")] >> AssemblyInfo.cs
echo [assembly: AssemblyDelaySign(false)] >> AssemblyInfo.cs
echo [assembly: AssemblyKeyFile("")] >> AssemblyInfo.cs
echo [assembly: AssemblyKeyName("")] >> AssemblyInfo.cs
echo.>> AssemblyInfo.cs


echo Creating Advanced Installer Script File
echo ;aic> installer.aic
echo SetVersion %CONFIG_VERSION_MAJOR%.%CONFIG_VERSION_MINOR%.%_buildno% >> installer.aic
echo Save >> installer.aic
echo Rebuild >> installer.aic

echo Creating PHP Version File
echo %CONFIG_VERSION_MAJOR%.%CONFIG_VERSION_MINOR%.%_buildno%> _version.txt

copy /Y %HEADERFILE%  ..\%HEADERFILE%
copy /Y %MKFILE% ..\%MKFILE%
copy /Y AssemblyInfo.cs  ..\AssemblyInfo.cs
copy /Y installer.aic ..\installer.aic
copy /Y _version.txt ..\setup\apache24\htdocs\portal\_include\_inc\_version.txt

del /F  %HEADERFILE%
del /F  %MKFILE%
del /F  AssemblyInfo.cs
del /F  installer.aic
del /F  _version.txt 

goto fin

:usage
echo usage: Configure BuildNumber [VersionSuffix]
echo    BuildNumber - Specify the IPStor build number
echo    VersionSuffix - Extra text to append to the product version string
echo       e.g. "RC2", "Beta3"
goto fin

:fin
cd /d %CONFIGCD%